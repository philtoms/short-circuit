const t=Symbol("_REDUCERS"),e=Symbol("_BASE"),n=Symbol("_PROPAGATE"),s=(o,r={})=>{const{t:i,parent:a={id:"",state:()=>b},s:c=[],o:d=[],i:u={},u:l={},l:f}=r;let{state:b={}}=r;const y=(n={},[s,...o])=>s?"."===s[0]?y(".."===s?n[e]:n,o):u[s]?y(u[s],o):o.length?y(n[s],o):[n[t],n[s]]:n[e]?y(n[e],[s,...o]):y(n,o),g=(t,e,n,s,o)=>{if(void 0===t)return b;if(t instanceof Promise)return t.then(t=>g(t,!1,n,s,o)),b;const r=e!==d;if(o)b=d.reduce((e,[,o,r])=>!r&&o(t[n],d,s,e)||e,b);else{b=t;const o=[a.id,n].join("/");r&&(b=d.reduce((t,[r,i,a])=>a&&r&&(s.startsWith(r)||o.startsWith(r))?(i(void 0===t[n]?t:t[n],d,s),b):!r&&"state"!==e&&i(void 0,d,s,t)||t,b))}const i=!e&&d.find(([t,,,e])=>t===n&&e);return f&&r&&f(b,s,!!i||e,!!n),i&&i[1](void 0,!0,s,b),b},j=(o,[i,j,m])=>{const[,,v,,S,p]=i.match(/(([\w]+):)?(\s*([^_]+))?(_)?/),[O,P=""]=S.split("$"),_=/^[\/\.]/.test(P),E="function"!=typeof j&&j,$=E&&Object.keys(E).some(t=>!t.startsWith("$"));if(m){const[t]=y(o,m.split("/"));return t.push([m.replace(/\./g,""),j,d]),o}const x=O.replace(/[#\.\-\[\]\(\)\"\=\^\&]/g,""),A=x||P?`${a.id}/${x||P}`:a.id||"/",R={id:A,address:x,signal:(t,e)=>y(o,t.split("/"))[1](e)},w=new Proxy(R,{get:(t,e)=>e in l?l[e]:R[e],set:(t,e,n)=>(l[e]=n,!0)}),C=E?s(E,{l:(t,e,n,s)=>g(s?{...b,[x]:t}:t,n,x,e||A),t:o,i:u,g:r.g,state:b[x],parent:{id:A,address:x,state:()=>b,j:$},s:c}):{};if("init"===P){const t=j.call(w,b);return t instanceof Promise?t.then(t=>{null!=t&&(b=t,f&&f(b,A,"state",!0))}):null!=t&&(b=t,f&&f(b,A,"state",!0)),o}const h=function(t,e,s,o=(x?b:a.state())){const r=void 0!==t,i=x||a.address;return r||(t=o[i]),r&&t===o[x]?b:(E?C[n]:g)(E?{...o,[i]:t}:p?((t,e)=>{const n=j.call(w,e);return void 0===n?void 0:n===e?b:{...b,[t]:n}})(i,t):j.call(w,o,t),e,E&&!$?"":x,s||A,$||!x&&a.j&&"state"!==P)};if(!_&&!P||"state"===P){d.push([x,h]);const[t,e]=y(u.root,A.split("/"));"function"==typeof e&&(d.push([x,e,t,!0]),t.push([x,h,d,!0]))}return _&&c.push([i,h,P]),Object.entries(C).forEach(([t,e])=>h[t]=e),h[t]=C[t],h[e]=C[e],"state"!==P&&(o[v||x||P]=h),u[r.g||"root"]=o,o},m=Object.entries(o).reduce(j,{[t]:d,[e]:i,[n]:g,get state(){return b},g:(t,e={})=>s(t,{...e,i:u,g:e.g||Object.keys(u).length})});return a.id?m:c.reduce(j,m)};export default s;