const t=Symbol("_REDUCERS"),e=Symbol("_BASE"),n=Symbol("_PROPAGATE"),s=(n={},[i,...o])=>"."===i?s(n,o):".."===i?s(n[e],o):i?o.length?s(n[i],o):[n[t],n[i]]:n[e]?s(n[e],[i,...o]):s(n,o),i=(o,r={})=>{const{t:a,s:c,parent:d={id:"",state:()=>v},i:u=[],o:f=[],u:l={},l:b}=r;let{state:v={}}=r;const g=(t,e,n,s,i)=>{if(t instanceof Promise)return t.then(t=>g(t,!1,n,s,i)),v;if(t===v)return v;void 0===t&&(t=v);const o=e!==f;i?v=f.reduce((e,[,s,i])=>!i&&s(t[n],f,e)||e,v):(v=t,o&&(v=f.reduce((t,[i,o,r])=>r&&i&&s.startsWith(i)?(o(void 0===t[n]?t:t[n],f),v):!i&&"state"!==e&&o(void 0,f,t)||t,v)));const r=!e&&f.find(([t,,,e])=>t===n&&e);return b&&o&&b(v,!!r||e,!!n),r&&r[1](void 0,!0,v),v},y=(o,[r,a,y])=>{const[,,S,,j,m]=r.match(/(([\w]+):)?(\s*([^_]+))?(_)?/),[p,_=""]=j.split("$"),E=/^[\/\.]/.test(_),O="function"!=typeof a&&a,P=O&&Object.keys(O).some(t=>!t.startsWith("$"));if(y){const[t]=s(o,y.split("/"));return t.push([y.replace(/\./g,""),a,f]),o}const $=p.replace(/[#\.\-\[\]\(\)\"\=\^\&]/g,""),x=$||_?`${d.id}/${$||_}`:d.id||"/",A={id:x,address:$,signal:(t,e)=>s(t.startsWith("//")&&c||o,t.split("/"))[1](e)},R=new Proxy(A,{get:(t,e)=>e in l?l[e]:A[e],set:(t,e,n)=>(l[e]=n,!0)}),w=O?i(O,{l:(t,e,n)=>g(n?{...v,[$]:t}:t,e,$,x),t:o,s:c,state:v[$]||v,parent:{id:x,address:$,state:()=>v,v:P},i:u}):{};if("init"===_){const t=a.call(R,$?v:d.state());if(!$)return void 0!==t&&(v=t,b&&b(v,"state")),o;t&&(v[$]=t[$])}const C=function(t,e,s=($?v:d.state())){const i=$||d.address;return void 0===t&&(t=s[i]),(O?w[n]:g)(O?{...s,[i]:t}:m?((t,e)=>{const n=a.call(R,e);return void 0===n?void 0:n===e?v:{...v,[t]:n}})(i,t):a.call(R,s,t),e,O&&!P?"":$,x,P||!$&&d.v&&"state"!==_)};if(!E&&!_||"state"===_){f.push([$,C]);const[t,e]=s(c,x.split("/"));"function"==typeof e&&(f.push([$,e,t,!0]),t.push([$,C,f,!0]))}return E&&u.push([r,C,_]),Object.entries(w).forEach(([t,e])=>C[t]=e),C[t]=w[t],C[e]=w[e],"state"!==_&&(o[S||$||_]=C),o},S=Object.entries(o).reduce(y,{[t]:f,[e]:a,[n]:g,get state(){return v},g:(t,e)=>i(t,{...e,s:S})});return d.id?S:u.reduce(y,S)};export default i;